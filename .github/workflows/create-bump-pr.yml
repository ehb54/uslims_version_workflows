name: Create Bump Version PR

# This workflow automates the creation of bump-to-version pull requests.
# It creates a new branch (bump-to-v<version>), updates the VERSION file,
# commits the change, and opens a PR to main.
#
# Behavior:
# - If VERSION already matches the requested version → exits successfully (no-op)
# - If an open PR already exists for this version → exits successfully (no-op)
# - If the bump-to branch exists but no PR exists → creates PR from existing branch
# - If the bump-to branch doesn't exist → creates branch, updates VERSION, and creates PR
# - Supports standard versions (1.2.3) and pre-release versions (1.2.3-RC1)
# - Fails if a tag for this version already exists
# - Tracks who requested the bump and provides traceability

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3 or 1.2.3-RC1)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-bump-to-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          set -euo pipefail
          
          VERSION="${{ inputs.version }}"
          
          # Semantic versioning with optional pre-release suffix
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-PRERELEASE"
            echo "Examples: 1.2.3, 1.2.3-RC1, 1.2.3-alpha"
            exit 1
          fi
          
          echo "Version format is valid: $VERSION"

      - name: Check if VERSION already matches
        id: version_check
        run: |
          set -euo pipefail

          # Default behavior: same as before (VERSION-only)
          SKIP=false

          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION | tr -d '\r\n')
            if [ "$CURRENT_VERSION" = "${{ inputs.version }}" ]; then
              SKIP=true
            fi
          fi

          # ultrascan3-only: require utils/us_defines.h to match too
          if [ "${GITHUB_REPOSITORY}" = "ehb54/ultrascan3" ]; then
            if [ ! -f utils/us_defines.h ]; then
              echo "Error: utils/us_defines.h not found in ehb54/ultrascan3"
              exit 1
            fi

            CURRENT_DEFINE="$(grep -E '^[[:space:]]*#define[[:space:]]+US_Version[[:space:]]+QString\("' utils/us_defines.h \
              | sed -E 's/.*QString\("([^"]*)"\).*/\1/' | head -n 1 | tr -d '\r\n')"

            if [ "${CURRENT_DEFINE:-}" != "${{ inputs.version }}" ]; then
              SKIP=false
            fi
          fi

          if [ "$SKIP" = "true" ]; then
            echo "Version already matches. No changes needed."
            echo "::warning::Version already matches ${{ inputs.version }} - no action taken"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Check if branch exists
        if: steps.version_check.outputs.skip != 'true'
        id: branch_check
        run: |
          if git ls-remote --exit-code --heads origin bump-to-v${{ inputs.version }} > /dev/null 2>&1; then
            echo "Branch bump-to-v${{ inputs.version }} already exists"
            echo "::warning::Branch bump-to-v${{ inputs.version }} already exists - will create PR from existing branch"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR already exists
        if: steps.version_check.outputs.skip != 'true'
        id: pr_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_EXISTS=$(gh pr list --head bump-to-v${{ inputs.version }} --base main --state open --json number --jq 'length')
          if [ "$PR_EXISTS" -gt 0 ]; then
            PR_NUMBER=$(gh pr list --head bump-to-v${{ inputs.version }} --base main --state open --json number --jq '.[0].number')
            echo "Pull request #$PR_NUMBER from bump-to-v${{ inputs.version }} to main already exists"
            echo "::warning::PR #$PR_NUMBER already exists for v${{ inputs.version }} - no action taken"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "exists=false" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true' && steps.branch_check.outputs.exists != 'true'
        run: |
          if git ls-remote --exit-code --tags origin v${{ inputs.version }} > /dev/null 2>&1; then
            echo "Error: Tag v${{ inputs.version }} already exists"
            echo "Cannot create version bump PR for a version that has already been tagged."
            exit 1
          fi

      - name: Configure git
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true' && steps.branch_check.outputs.exists != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create bump-to branch
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true' && steps.branch_check.outputs.exists != 'true'
        run: |
          git checkout -b bump-to-v${{ inputs.version }}

      - name: Update VERSION file
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true' && steps.branch_check.outputs.exists != 'true'
        run: |
          set -euo pipefail

          echo "${{ inputs.version }}" > VERSION
          git add VERSION

          # ultrascan3-only: keep US_Version in sync with VERSION
          if [ "${GITHUB_REPOSITORY}" = "ehb54/ultrascan3" ]; then
            if [ ! -f utils/us_defines.h ]; then
              echo "Error: utils/us_defines.h not found in ehb54/ultrascan3"
              exit 1
            fi

            COUNT="$(grep -cE '^[[:space:]]*#define[[:space:]]+US_Version[[:space:]]+QString\("' utils/us_defines.h || true)"
            if [ "$COUNT" -ne 1 ]; then
              echo "Error: expected exactly 1 US_Version define, found $COUNT"
              exit 1
            fi

            perl -0777 -i -pe 's/^(\s*#define\s+US_Version\s+QString\(")[^"]*("\).*)$/${1}'"${{ inputs.version }}"'${2}/m' utils/us_defines.h
            git add utils/us_defines.h
          fi

      - name: Commit version bump
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true' && steps.branch_check.outputs.exists != 'true'
        run: |
          git commit -m "Bump version to ${{ inputs.version }}"

      - name: Push bump branch
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true' && steps.branch_check.outputs.exists != 'true'
        run: |
          git push origin bump-to-v${{ inputs.version }}

      - name: Create Pull Request
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          
          # Create the PR with enhanced metadata
          PR_URL=$(gh pr create \
          --title "Bump to v${{ inputs.version }}" \
          --body "Automated version bump to **${{ inputs.version }}**
          
          ## Details
          - **Version Type:** ${VERSION_TYPE}
          - **Requested by:** @${{ github.actor }}
          - **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ## Checklist
          - [ ] Verify version number is correct
          - [ ] Check CHANGELOG is updated (if applicable)
          - [ ] Ensure all tests pass
          
          ---
          *This PR was automatically created by the bump version workflow.*" \
          --base main \
          --head bump-to-v${{ inputs.version }} \
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          
          # Extract PR number from URL
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
          echo "Created pull request #$PR_NUMBER"
  
          - name: Workflow Summary
            if: always()
            env:
              GH_TOKEN: ${{ github.token }}
            run: |
              echo "## Version Bump Workflow Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Status
              if [ "${{ steps.version_check.outputs.skip }}" = "true" ]; then
                echo "### Status: No Action Needed" >> $GITHUB_STEP_SUMMARY
                echo "Version already matches **${{ inputs.version }}**. No changes required." >> $GITHUB_STEP_SUMMARY
              elif [ "${{ steps.pr_check.outputs.exists }}" = "true" ]; then
                echo "### Status: PR Already Exists" >> $GITHUB_STEP_SUMMARY
                PR_NUM="${{ steps.pr_check.outputs.pr_number }}"
                echo "Pull request [#$PR_NUM](${{ github.server_url }}/${{ github.repository }}/pull/$PR_NUM) already exists for this version." >> $GITHUB_STEP_SUMMARY
              elif [ "${{ job.status }}" = "failure" ]; then
                echo "### Status: Workflow Failed" >> $GITHUB_STEP_SUMMARY
                echo "The version bump workflow encountered an error. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
              else
                echo "### Status: PR Created Successfully" >> $GITHUB_STEP_SUMMARY
                PR_NUM="${{ steps.create_pr.outputs.pr_number }}"
                if [ -n "$PR_NUM" ]; then
                  echo "Pull request [#$PR_NUM](${{ github.server_url }}/${{ github.repository }}/pull/$PR_NUM) has been created." >> $GITHUB_STEP_SUMMARY
                fi
              fi
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Details" >> $GITHUB_STEP_SUMMARY
              echo "- **Version:** \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Requested by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Branch:** bump-to-v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
