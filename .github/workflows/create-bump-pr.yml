name: Create Bump Version PR

on:
  workflow_call:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3 or 1.2.3-RC1)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-bump-to-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute desired version + sanity check
        id: desired
        run: |
          set -euo pipefail
          DESIRED="${{ inputs.version }}"
          if [ -z "$DESIRED" ]; then
            echo "Error: inputs.version is empty"
            exit 1
          fi
          echo "version=$DESIRED" >> "$GITHUB_OUTPUT"

      - name: Check if VERSION and utils/us_defines.h already match
        id: version_check
        run: |
          set -euo pipefail
          DESIRED="${{ steps.desired.outputs.version }}"

          # Check VERSION
          VERSION_MATCH=false
          if [ -f VERSION ]; then
            CURRENT_VERSION="$(cat VERSION | tr -d '\r\n')"
            if [ "$CURRENT_VERSION" = "$DESIRED" ]; then
              VERSION_MATCH=true
            fi
          fi

          # Check utils/us_defines.h
          DEFINES_MATCH=false
          if [ -f utils/us_defines.h ]; then
            # Extract the string inside QString("...") for US_Version
            CURRENT_DEFINE="$(grep -E '^[[:space:]]*#define[[:space:]]+US_Version[[:space:]]+QString\("' utils/us_defines.h \
              | sed -E 's/.*QString\("([^"]*)"\).*/\1/' | head -n 1 | tr -d '\r\n')"

            if [ "${CURRENT_DEFINE:-}" = "$DESIRED" ]; then
              DEFINES_MATCH=true
            fi
          fi

          echo "version_match=$VERSION_MATCH" >> "$GITHUB_OUTPUT"
          echo "defines_match=$DEFINES_MATCH" >> "$GITHUB_OUTPUT"

          if [ "$VERSION_MATCH" = "true" ] && [ "$DEFINES_MATCH" = "true" ]; then
            echo "Both VERSION and utils/us_defines.h already match $DESIRED. No changes needed."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists
        if: steps.version_check.outputs.skip != 'true'
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --tags origin v${{ steps.desired.outputs.version }} > /dev/null 2>&1; then
            echo "Error: Tag v${{ steps.desired.outputs.version }} already exists"
            exit 1
          fi

      - name: Configure git
        if: steps.version_check.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if branch exists
        if: steps.version_check.outputs.skip != 'true'
        id: branch_check
        run: |
          set -euo pipefail
          BR="bump-to-v${{ steps.desired.outputs.version }}"
          if git ls-remote --exit-code --heads origin "$BR" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          echo "branch=$BR" >> $GITHUB_OUTPUT

      - name: Check if PR already exists
        if: steps.version_check.outputs.skip != 'true'
        id: pr_check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          BR="${{ steps.branch_check.outputs.branch }}"
          PR_EXISTS=$(gh pr list --head "$BR" --base main --state open --json number --jq 'length')
          if [ "$PR_EXISTS" -gt 0 ]; then
            echo "Pull request from $BR to main already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "exists=false" >> $GITHUB_OUTPUT

      - name: Create or checkout bump branch
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true'
        run: |
          set -euo pipefail
          BR="${{ steps.branch_check.outputs.branch }}"
          if [ "${{ steps.branch_check.outputs.exists }}" = "true" ]; then
            git fetch origin "$BR":"$BR"
            git checkout "$BR"
          else
            git checkout -b "$BR"
          fi

      - name: Update VERSION + utils/us_defines.h (US_Version)
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true'
        run: |
          set -euo pipefail
          DESIRED="${{ steps.desired.outputs.version }}"

          # Update VERSION
          echo "$DESIRED" > VERSION

          # Update utils/us_defines.h
          if [ ! -f utils/us_defines.h ]; then
            echo "Error: utils/us_defines.h not found"
            exit 1
          fi

          # Ensure exactly one US_Version define exists
          COUNT="$(grep -cE '^[[:space:]]*#define[[:space:]]+US_Version[[:space:]]+QString\("' utils/us_defines.h || true)"
          if [ "$COUNT" -ne 1 ]; then
            echo "Error: expected exactly 1 US_Version define, found $COUNT"
            exit 1
          fi

          # Replace the QString("...") contents
          perl -0777 -i -pe 's/^(\s*#define\s+US_Version\s+QString\(")[^"]*("\).*)$/${1}'"$DESIRED"'${2}/m' utils/us_defines.h

          git add VERSION utils/us_defines.h

      - name: Commit and push if changed
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true'
        run: |
          set -euo pipefail
          BR="${{ steps.branch_check.outputs.branch }}"
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Bump version to ${{ steps.desired.outputs.version }}"
            git push -u origin "$BR"
          fi

      - name: Create Pull Request (if missing)
        if: steps.version_check.outputs.skip != 'true' && steps.pr_check.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          BR="${{ steps.branch_check.outputs.branch }}"
          gh pr create \
            --title "Bump to v${{ steps.desired.outputs.version }}" \
            --body "Automated PR for bump to version ${{ steps.desired.outputs.version }}" \
            --base main \
            --head "$BR"