name: Verify Tag matches VERSION file

on:
  push:
    tags:
      - 'v*'

jobs:
  verify-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tagged commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify tag matches VERSION file
        run: |
          set -euo pipefail
          
          # Get the tag name from GitHub context
          TAG="${GITHUB_REF_NAME}"
          echo "Tag pushed: ${TAG}"
          echo ""
          
          # Validate tag format and extract full version (base + suffix)
          # Regex: vX.Y.Z or vX.Y.Z-<suffix>
          REGEX='^v([0-9]+\.[0-9]+\.[0-9]+(?:-[0-9A-Za-z._-]+)?)$'
          
          if [[ "${TAG}" =~ ${REGEX} ]]; then
            FULL_VERSION="${BASH_REMATCH[1]}"
          
            echo "PASS: Tag format valid"
            echo "  Full version: ${FULL_VERSION}"
            echo ""
          else
            echo "ERROR: Tag does not match allowed format"
            echo "=========================================="
            echo "Tag: ${TAG}"
            echo "=========================================="
            echo ""
            echo "Allowed formats:"
            echo "  - vX.Y.Z           (example: v1.2.3)"
            echo "  - vX.Y.Z-<suffix>  (examples: v1.2.3-RC1, v1.2.3-rc.1, v1.2.3-hotfix2)"
            echo ""
            echo "Where X, Y, Z are integers (semantic version)."
            exit 1
          fi
          
          # Check if VERSION file exists
          if [[ ! -f VERSION ]]; then
            echo "ERROR: VERSION file not found"
            echo "Expected location: ./VERSION (repository root)"
            exit 1
          fi
          
          # Read VERSION file and strip all whitespace (spaces, tabs, newlines)
          VERSION_CONTENT=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION file content (trimmed): '${VERSION_CONTENT}'"
          echo ""
          
          # Compare full version with VERSION file content
          if [[ "${VERSION_CONTENT}" != "${FULL_VERSION}" ]]; then
            echo "ERROR: VERSION file mismatch"
            echo "=========================================="
            echo "Full tag name:      ${TAG}"
            echo "Expected version:   ${FULL_VERSION}"
            echo "VERSION file value: ${VERSION_CONTENT}"
            echo "=========================================="
            echo ""
            echo "Fix: Update VERSION file to contain exactly:"
            echo "     ${FULL_VERSION}"
            echo ""
            echo "(No 'v' prefix, but suffix MUST be included if present in tag)"
            exit 1
          fi
          
          # Success
          echo "=========================================="
          echo "SUCCESS: VERSION file matches tag"
          echo "=========================================="
          echo "Tag:          ${TAG}"
          echo "Full version: ${FULL_VERSION}"
          echo "VERSION file: ${VERSION_CONTENT}"
          echo "=========================================="
